<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Analisis Poisson - Quality Control</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px; background-color: #f4f7f6; color: #333; }
        
        /* Header & Button Styles */
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .header-actions { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .btn { display: inline-block; padding: 10px 20px; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: 0.3s; margin: 0 5px; border: none; cursor: pointer;}
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background-color: #3498db; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.2); }
        .btn-secondary { background-color: #95a5a6; }

        /* Card Styles */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; overflow: hidden; }
        .card-header { background-color: #2c3e50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { margin: 0; font-size: 1.2rem; }
        .card-body { padding: 20px; }

        /* Layout Grid (Kiri: History, Kanan: Prediksi) */
        .grid-container { display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; }
        @media (max-width: 768px) { .grid-container { grid-template-columns: 1fr; } }

        /* Table Styles */
        .table-container h3 { font-size: 1rem; color: #7f8c8d; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #2c3e50; font-weight: 600; }
        
        /* Highlight Styles */
        .high-risk { background-color: #e74c3c; color: white; font-weight: bold; border-radius: 4px; }
        /* TAMBAHAN: STYLE WARNA HIJAU */
        .good-chance { background-color: #27ae60; color: white; font-weight: bold; border-radius: 4px; }
        
        .stat-badge { background: #ecf0f1; color: #2c3e50; padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        
        /* Scrollable History Table */
        .history-scroll { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }

        /* Style Tombol Aksi */
        .action-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; transition: transform 0.2s; text-decoration: none; display: inline-block; margin: 0 3px; }
        .action-btn:hover { transform: scale(1.2); }
    </style>
</head>
<body>
    <h1>üè≠ Dashboard Quality Control (Poisson)</h1>

    <div class="header-actions">
        <a href="/input" class="btn btn-primary">üìù + Input Data Manual</a>
        <a href="/seed" class="btn btn-secondary" onclick="return confirm('Reset data dummy?')">üîÑ Reset Data Dummy</a>
    </div>

    <% if (report.length === 0) { %>
        <div style="text-align: center; color: #7f8c8d; margin-top: 50px;">
            <h3>Belum ada data produksi.</h3>
            <p>Silakan input data manual atau gunakan data dummy.</p>
        </div>
    <% } %>

    <% report.forEach(item => { %>
        <div class="card">
            <div class="card-header">
                <h2>üì¶ <%= item.name %></h2>
                <span class="stat-badge">Rata-rata Cacat (Œª): <%= item.lambda %></span>
            </div>
            
            <div class="card-body">
                <div class="grid-container">
                    
                    <div class="table-container">
                        <h3>üìã Riwayat Input (Data Asli)</h3>
                        <div class="history-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Produksi</th>
                                        <th>Cacat</th>
                                        <th>Aksi</th> 
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (item.logs.length === 0) { %>
                                        <tr><td colspan="4">Belum ada history</td></tr>
                                    <% } else { %>
                                        <% item.logs.forEach(log => { %>
                                            <tr>
                                                <td style="color: #7f8c8d;">
                                                    <%= new Date(log.date).toLocaleDateString('id-ID') %>
                                                </td>
                                                <td><%= log.total_produced %> unit</td>
                                                <td style="color: <%= log.defect_count > 0 ? '#e74c3c' : '#27ae60' %>; font-weight: bold;">
                                                    <%= log.defect_count %>
                                                </td>
                                                <td>
                                                    <a href="/edit-log/<%= log.id %>" class="action-btn" title="Edit Data">‚úèÔ∏è</a>
                                                    <form action="/delete-log/<%= log.id %>" method="POST" style="display:inline;" onsubmit="return confirm('Yakin hapus data tanggal <%= new Date(log.date).toLocaleDateString() %>?')">
                                                        <button type="submit" class="action-btn" title="Hapus Data">üóëÔ∏è</button>
                                                    </form>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3>üìä Prediksi Peluang (Batch Berikutnya)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Jlh Cacat (x)</th>
                                    <% item.predictions.forEach(p => { %> <th><%= p.count %></th> <% }) %>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Peluang</strong></td>
                                    <% item.predictions.forEach(p => { %>
                                        <td>
                                            <% if (p.count === 0) { %>
                                                <% if (p.chance > 50) { %>
                                                    <span class="good-chance" style="padding: 4px 8px; display: inline-block;">
                                                        <%= p.chance %>%
                                                    </span>
                                                <% } else { %>
                                                    <%= p.chance %>%
                                                <% } %>
                                            <% } else { %>
                                                <% if (p.chance > 20) { %>
                                                    <span class="high-risk" style="padding: 4px 8px; display: inline-block;">
                                                        <%= p.chance %>%
                                                    </span>
                                                <% } else { %>
                                                    <%= p.chance %>%
                                                <% } %>
                                            <% } %>
                                        </td>
                                    <% }) %>
                                </tr>
                            </tbody>
                        </table>
                        <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 10px;">
                            <span style="color: #27ae60; font-weight: bold;">Hijau</span> = Peluang mulus (tanpa cacat) tinggi.<br>
                            <span style="color: #e74c3c; font-weight: bold;">Merah</span> = Risiko cacat sangat tinggi.
                        </p>
                    </div>

                </div>
            </div>
        </div>
    <% }) %>

</body>
</html>